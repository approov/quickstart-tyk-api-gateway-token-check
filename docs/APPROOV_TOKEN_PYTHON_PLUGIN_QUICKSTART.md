# Approov Token Python Plugin Quickstart

This quickstart is for developers familiar with Tyk who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. Therefore this will guide you through the necessary steps for adding the Approov token check to an existing Tyk API Gateway as a Python plugin middleware.


## TOC - Table of Contents

* [Why?](#why)
* [How it Works?](#how-it-works)
* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-check)
* [Test your Approov Integration](#test-your-approov-integration)


## Why?

To lock down your API server to your mobile app. Please read the brief summary in the [README](/README.md#why) at the root of this repo or visit our [website](https://approov.io/product.html) for more details.

[TOC](#toc---table-of-contents)


## How it works?

For more background, see the overview in the [README](/README.md#how-it-works) at the root of this repo.


[TOC](#toc---table-of-contents)


## Requirements

To complete this quickstart you will need to already have an Tyk API Gateway created, and the Approov CLI tool installed.

* [Tyk API Gateway](https://tyk.io/docs/getting-started/)
* [Approov CLI](https://approov.io/docs/latest/approov-installation/#approov-tool) - Learn how to use it [here](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the Tyk API Gateway we need a small amount of configuration. First, Approov needs to know the API domain that will be protected. Second, the Tyk API Gateway needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

### Configure API Domain

Approov needs to know the domain name of the API for which it will issue tokens.

Add it with:

```bash
approov api -add your.tyk-api-gateway.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning) setup, out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box issuing the Approov CLI command and the Approov servers.

### Approov Secret

Approov tokens are signed with a symmetric secret. To verify tokens, we need to grab the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the Tyk API Gateway configuration to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.


To retrieved the Approov secret you need to enable your `admin` role with:

```bash
eval `approov role admin`
````

Retrieve the Approov secret with:

```bash
approov secret -get base64
```

Next, set the secret in the Tyk server environment:

```bash
export APPROOV_BASE64_SECRET=___YOUR_APPROOV_BASE64_SECRET_HERE___
```

[TOC](#toc---table-of-contents)


## Approov Token Check

To check the Approov token in any existing Tyk API Gateway project we will use a Python plugin that will run as a Tyk middleware.

### Tyk Configuration

You need to enable the use of the Tyk middleware for Python in your `tyk.conf` file:

```json
"coprocess_options": {
  "enable_coprocess": true,
  "coprocess_grpc_server": "",
  "python_path_prefix": "/opt/tyk-gateway"
},
"middleware_path": "/opt/tyk-gateway/middleware",
"enable_bundle_downloader": true,
"bundle_base_url": "https://your-bundle-base-url.com/tyk-bundles/",
"public_key_path": "/path/to/my/public-key",
```

### Tyk Bundle

Tyk requires the bundle to be accessible via an URL. See more details in the Tyk docs at [Downloading and Updating Bundles](https://tyk.io/docs/plugins/how-to-serve-plugins/plugin-bundles/#downloading-and-updating-bundles).

Bear in mind that Tyk caches the bundle after downloading it for the first time, therefore you need to version it, for example `approov-python-plugin-bundle-01.zip`, and each time you modify it you will increment the version, update the API definition accordingly and then reload Tyk. Alternatively, you may delete the cached bundle from Tyk manually at `{TYK ROOT}/{CONFIG_MIDDLEWARE_PATH}/bundles`, that by default its `/opt/tyk-gateway/middleware/bundles`, followed by a hot reload that will download the new bundle.

The bundle needs to be signed with the private key for the public key you provided in the `tyk.conf` file. Build the bundle with:

```bash
/opt/tyk-gateway/tyk bundle build --key /path/to/my/private-key --output /opt/tyk-gateway/middleware/bundles/approov-python-plugin-bundle-01.zip
```

Next, upload the `/opt/tyk-gateway/middleware/bundles/approov-python-plugin-bundle-01.zip` to the base URL you have defined in the `tyk.conf` file so that it will be acessible at `https://your-bundle-base-url.com/tyk-bundles/approov-python-plugin-bundle-01.zip`.


### Tyk API Configuration

You need to configure your API definition with the name of the bundle file used in the previous step:

```json
"custom_middleware_bundle": "approov-python-plugin-bundle-01.zip"
```

### Tyk Security Policy

Optionally you can create a new Tyk security policy for the API protected with the Approov token check. We recommend to disable rate limits and quotas, because when an Approov token check is valid the API request comes from a trusted mobile app. If you still prefer to use rate limiting and quotas then feel free to continue using your current security policy.

Tyk supports several ways of creating a security policy, but all of them require the same fields to be given, therefore use the approach you are more comfortable with, and ensure that the following fields are set:

```json
{
    "approov": {
      "access_rights": {
        "___YOUR_API_ID_HERE___": {
          "allowed_urls": [],
          "api_id": "___YOUR_API_ID_HERE___",
          "api_name": "___YOUR_API_NAME_HERE___}",
          "versions": [
              "Default"
          ]
        }
      },
      "org_id": "___YOUR_ORG_ID_HERE___",
      "active": true,
      "name": "Approov",
      "rate": 0,
      "per": 1,
      "quota_max": -1,
      "state": "active",
      "tags": ["Approov"]
    }
}
```

### Tyk Reload

Finally, reload your Tyk API Gateway and confirm that only serves API requests with a correctly signed and not expired `Approov-Token` header. The next section has some guidance on how to test your Approov integration.

A full working example can be found at [examples/TYK_GATEWAY_APPROOV_PYTHON_PLUGIN_EXAMPLE.md](/examples/TYK_GATEWAY_APPROOV_PYTHON_PLUGIN_EXAMPLE.md).

[TOC](#toc---table-of-contents)


## Test your Approov Integration

The following examples below use cURL to perform the API requests.

For more testing scenarios see the full working example for a Tyk API Gateway at [Testing the Approov Integration](/examples/TYK_GATEWAY_APPROOV_PYTHON_PLUGIN_EXAMPLE.md#testing-the-approov-integration).

### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```bash
approov token -genExample your.tyk-api-gateway.domain.com
```

Then make the request with the generated token:

```bash
curl https://your.tyk-api-gateway.domain.com \
  -i \
  --header 'Api-Key: YOUR_API_KEY_HERE' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The request should be accepted. For example:

```text
HTTP/1.1 200 OK
Access-Control-Allow-Credentials: true
Access-Control-Allow-Origin: *
Content-Length: 53
Content-Type: application/json
Date: Wed, 31 Aug 2022 16:11:33 GMT
Server: gunicorn/19.9.0
X-Ratelimit-Limit: -1
X-Ratelimit-Remaining: 0
X-Ratelimit-Reset: 0

{
  "uuid": "35168518-b391-40ff-82c7-4ed2743837d6"
}
```

### With Invalid Approov Tokens

Generate an invalid token example from the Approov Cloud service:

```bash
approov token -type invalid -genExample your.tyk-api-gateway.domain.com
```

Then make the request with the generated token:

```bash
curl https://your.tyk-api-gateway.domain.com \
  -i \
  --header 'Api-Key: YOUR_API_KEY_HERE' \
  --header 'Approov-Token: APPROOV_INVALID_TOKEN_EXAMPLE_HERE'
```

The above request should fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized
Content-Type: application/json
X-Generator: tyk.io
Date: Thu, 08 Sep 2022 19:23:57 GMT
Content-Length: 31

{
    "error": "Unauthorized"
}
```

[TOC](#toc---table-of-contents)


## Issues

If you find any issue while following our instructions then just report it [here](https://github.com/approov/quickstart-tyk-api-gateway-token-check/issues), with the steps to reproduce it, and we will sort it out and/or guide you to the correct path.

[TOC](#toc---table-of-contents)


## Useful Links

If you wish to explore the Approov solution in more depth, then why not try one of the following links as a jumping off point:

* [Approov Free Trial](https://approov.io/signup)(no credit card needed)
* [Approov Get Started](https://approov.io/product/demo)
* [Approov QuickStarts](https://approov.io/docs/latest/approov-integration-examples/)
* [Approov Docs](https://approov.io/docs)
* [Approov Blog](https://approov.io/blog/)
* [Approov Resources](https://approov.io/resource/)
* [Approov Customer Stories](https://approov.io/customer)
* [Approov Support](https://approov.io/contact)
* [About Us](https://approov.io/company)
* [Contact Us](https://approov.io/contact)

[TOC](#toc---table-of-contents)
